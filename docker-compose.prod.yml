# ─────────────────────────────────────────────────────────────────────────────
# VoxSentinel — Production Overrides
# Usage:  docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
# ─────────────────────────────────────────────────────────────────────────────

x-restart-policy: &restart-policy
  restart: unless-stopped

x-prod-env: &prod-env
  TG_LOG_LEVEL: WARNING

services:
  # ── Infrastructure ─────────────────────────────────────────────────────────
  redis:
    <<: *restart-policy
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "1.0"

  postgres:
    <<: *restart-policy
    environment:
      POSTGRES_USER: voxsentinel
      POSTGRES_PASSWORD: ${TG_DB_PASSWORD:-changeme}
      POSTGRES_DB: voxsentinel
      POSTGRES_INITDB_ARGS: "--data-checksums"
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "2.0"
    command: >
      postgres
        -c shared_preload_libraries=timescaledb
        -c max_connections=200
        -c shared_buffers=512MB
        -c effective_cache_size=1536MB
        -c work_mem=16MB

  elasticsearch:
    <<: *restart-policy
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms1g -Xmx1g
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "2.0"

  kibana:
    <<: *restart-policy
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.0"

  # ── Application Services ───────────────────────────────────────────────────
  api:
    <<: *restart-policy
    environment:
      <<: *prod-env
      TG_API_HOST: "0.0.0.0"
      TG_API_PORT: "8000"
      TG_DB_URI: postgresql+asyncpg://voxsentinel:${TG_DB_PASSWORD:-changeme}@postgres:5432/voxsentinel
      TG_REDIS_URL: redis://redis:6379/0
      TG_ES_URL: http://elasticsearch:9200
      TG_CELERY_BROKER_URL: redis://redis:6379/1
      TG_CELERY_RESULT_BACKEND: redis://redis:6379/2
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.0"

  ingestion:
    <<: *restart-policy
    environment:
      <<: *prod-env
      TG_DB_URI: postgresql+asyncpg://voxsentinel:${TG_DB_PASSWORD:-changeme}@postgres:5432/voxsentinel
      TG_REDIS_URL: redis://redis:6379/0
      TG_ES_URL: http://elasticsearch:9200
      TG_CELERY_BROKER_URL: redis://redis:6379/1
      TG_CELERY_RESULT_BACKEND: redis://redis:6379/2
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "2.0"

  vad:
    <<: *restart-policy
    build:
      context: .
      dockerfile: services/vad/Dockerfile
      args:
        TORCH_INDEX: https://download.pytorch.org/whl/cu124
    environment:
      <<: *prod-env
      TG_DB_URI: postgresql+asyncpg://voxsentinel:${TG_DB_PASSWORD:-changeme}@postgres:5432/voxsentinel
      TG_REDIS_URL: redis://redis:6379/0
      TG_ES_URL: http://elasticsearch:9200
      TG_CELERY_BROKER_URL: redis://redis:6379/1
      TG_CELERY_RESULT_BACKEND: redis://redis:6379/2
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "2.0"

  asr:
    <<: *restart-policy
    build:
      context: .
      dockerfile: services/asr/Dockerfile
      args:
        TORCH_INDEX: https://download.pytorch.org/whl/cu124
    environment:
      <<: *prod-env
      TG_DB_URI: postgresql+asyncpg://voxsentinel:${TG_DB_PASSWORD:-changeme}@postgres:5432/voxsentinel
      TG_REDIS_URL: redis://redis:6379/0
      TG_ES_URL: http://elasticsearch:9200
      TG_CELERY_BROKER_URL: redis://redis:6379/1
      TG_CELERY_RESULT_BACKEND: redis://redis:6379/2
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: "4.0"
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  nlp:
    <<: *restart-policy
    build:
      context: .
      dockerfile: services/nlp/Dockerfile
      args:
        TORCH_INDEX: https://download.pytorch.org/whl/cu124
    environment:
      <<: *prod-env
      TG_DB_URI: postgresql+asyncpg://voxsentinel:${TG_DB_PASSWORD:-changeme}@postgres:5432/voxsentinel
      TG_REDIS_URL: redis://redis:6379/0
      TG_ES_URL: http://elasticsearch:9200
      TG_CELERY_BROKER_URL: redis://redis:6379/1
      TG_CELERY_RESULT_BACKEND: redis://redis:6379/2
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: "4.0"
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  diarization:
    <<: *restart-policy
    build:
      context: .
      dockerfile: services/diarization/Dockerfile
      args:
        TORCH_INDEX: https://download.pytorch.org/whl/cu124
    environment:
      <<: *prod-env
      TG_DB_URI: postgresql+asyncpg://voxsentinel:${TG_DB_PASSWORD:-changeme}@postgres:5432/voxsentinel
      TG_REDIS_URL: redis://redis:6379/0
      TG_ES_URL: http://elasticsearch:9200
      TG_CELERY_BROKER_URL: redis://redis:6379/1
      TG_CELERY_RESULT_BACKEND: redis://redis:6379/2
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: "4.0"
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]

  alerts:
    <<: *restart-policy
    environment:
      <<: *prod-env
      TG_DB_URI: postgresql+asyncpg://voxsentinel:${TG_DB_PASSWORD:-changeme}@postgres:5432/voxsentinel
      TG_REDIS_URL: redis://redis:6379/0
      TG_ES_URL: http://elasticsearch:9200
      TG_CELERY_BROKER_URL: redis://redis:6379/1
      TG_CELERY_RESULT_BACKEND: redis://redis:6379/2
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "1.0"

  storage:
    <<: *restart-policy
    environment:
      <<: *prod-env
      TG_DB_URI: postgresql+asyncpg://voxsentinel:${TG_DB_PASSWORD:-changeme}@postgres:5432/voxsentinel
      TG_REDIS_URL: redis://redis:6379/0
      TG_ES_URL: http://elasticsearch:9200
      TG_CELERY_BROKER_URL: redis://redis:6379/1
      TG_CELERY_RESULT_BACKEND: redis://redis:6379/2
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.0"

  dashboard:
    <<: *restart-policy
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"

  celery-worker:
    <<: *restart-policy
    command: celery -A tg_common.messaging.celery_app worker --loglevel=warning --concurrency=8
    environment:
      <<: *prod-env
      TG_DB_URI: postgresql+asyncpg://voxsentinel:${TG_DB_PASSWORD:-changeme}@postgres:5432/voxsentinel
      TG_REDIS_URL: redis://redis:6379/0
      TG_ES_URL: http://elasticsearch:9200
      TG_CELERY_BROKER_URL: redis://redis:6379/1
      TG_CELERY_RESULT_BACKEND: redis://redis:6379/2
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "2.0"
